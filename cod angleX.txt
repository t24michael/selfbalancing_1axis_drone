#include "Wire.h"
#include "I2Cdev.h"
#include "MPU6050.h"

MPU6050 mpu;

int deadzone = 5;
float alfa = 0.5;

float angleX;

int16_t accY, accZ;
float accAngle;

int16_t gyroX, gyroRate;
float gyroAngle=0;
float currTime, prevTime=0, loopTime;

void setup() {  
  mpu.initialize();
  mpu.setYAccelOffset(-641);
  mpu.setZAccelOffset(1304);
  mpu.setXGyroOffset(-76);

  Serial.begin(9600);
}

void loop() {
  currTime = millis();
  loopTime = currTime - prevTime;
  prevTime = currTime;

  accZ = mpu.getAccelerationZ();
  accY = mpu.getAccelerationY();
   
  accAngle = atan2(accY, accZ)*RAD_TO_DEG;

  gyroX = mpu.getRotationX();
  
  gyroRate = map(gyroX, -32768, 32767, -250, 250);
  if(gyroRate < deadzone || gyroRate > -deadzone) gyroRate = 0;

  gyroAngle = gyroAngle + (float)gyroRate*loopTime/1000;

  angleX = alfa * accAngle + (1 - alfa) * gyroAngle;
  
  if(isnan(angleX));
  else
    Serial.println(angleX);
}